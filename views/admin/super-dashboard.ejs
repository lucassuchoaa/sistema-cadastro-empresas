<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Super Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="/css/style.css" rel="stylesheet">
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-crown me-2"></i>
                Super Admin Dashboard
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/admin/criar-empresa">
                    <i class="fas fa-plus me-1"></i>
                    Nova Empresa
                </a>
                <a class="nav-link" href="/admin/logout">
                    <i class="fas fa-sign-out-alt me-1"></i>
                    Sair
                </a>
            </div>
        </div>
    </nav>
    
    <div class="container mt-4">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col">
                <h2>Dashboard Super Administrador</h2>
                <p class="text-muted">Gerencie todas as empresas e seus colaboradores</p>
            </div>
        </div>
        
        <!-- Estatísticas Gerais -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title text-muted">Total de Empresas</h6>
                                <h3 class="mb-0"><%= Object.keys(empresas).length %></h3>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-building fa-2x text-primary"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title text-muted">Total de Colaboradores</h6>
                                <h3 class="mb-0">
                                    <% let totalColaboradores = 0; %>
                                    <% Object.keys(colaboradores).forEach(empresa => { %>
                                        <% totalColaboradores += (colaboradores[empresa] || []).length; %>
                                    <% }); %>
                                    <%= totalColaboradores %>
                                </h3>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-users fa-2x text-success"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title text-muted">Cadastros Hoje</h6>
                                <h3 class="mb-0">
                                    <% let cadastrosHoje = 0; %>
                                    <% const hoje = new Date().toLocaleDateString('pt-BR'); %>
                                    <% Object.keys(colaboradores).forEach(empresa => { %>
                                        <% (colaboradores[empresa] || []).forEach(c => { %>
                                            <% if (c.dataRegistro === hoje) cadastrosHoje++; %>
                                        <% }); %>
                                    <% }); %>
                                    <%= cadastrosHoje %>
                                </h3>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-calendar-day fa-2x text-warning"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="card-title text-muted">Empresas Ativas</h6>
                                <h3 class="mb-0"><%= Object.keys(empresas).length %></h3>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-chart-line fa-2x text-info"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Filtros e Ações -->
        <div class="row mb-4">
            <div class="col">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Filtros e Ações</h5>
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label for="filtroEmpresa" class="form-label">Filtrar por Empresa:</label>
                                <select class="form-select" id="filtroEmpresa" onchange="filtrarPorEmpresa()">
                                    <option value="">Todas as Empresas</option>
                                    <% Object.keys(empresas).forEach(slug => { %>
                                        <option value="<%= slug %>"><%= empresas[slug].nome %></option>
                                    <% }); %>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="dataInicio" class="form-label">Data Início:</label>
                                <input type="date" class="form-control" id="dataInicio">
                            </div>
                            <div class="col-md-4">
                                <label for="dataFim" class="form-label">Data Fim:</label>
                                <input type="date" class="form-control" id="dataFim">
                            </div>
                        </div>
                        <div class="row g-3 mt-2">
                            <div class="col-md-6">
                                <input type="text" class="form-control" id="searchInput" placeholder="Buscar colaborador...">
                            </div>
                            <div class="col-md-6 d-flex gap-2">
                                <button class="btn btn-primary" onclick="aplicarFiltros()">
                                    <i class="fas fa-filter me-1"></i>Filtrar
                                </button>
                                <button class="btn btn-secondary" onclick="limparFiltros()">
                                    <i class="fas fa-times me-1"></i>Limpar
                                </button>
                                <a href="/admin/criar-empresa" class="btn btn-success">
                                    <i class="fas fa-plus me-1"></i>Nova Empresa
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Lista de Empresas -->
        <div class="row mb-4">
            <div class="col">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Empresas Cadastradas</h5>
                    </div>
                    <div class="card-body">
                        <% if (Object.keys(empresas).length > 0) { %>
                            <div class="row">
                                <% Object.keys(empresas).forEach(slug => { %>
                                    <div class="col-md-4 mb-3">
                                        <div class="card h-100 stats-card">
                                            <div class="card-body">
                                                <h6 class="card-title"><%= empresas[slug].nome %></h6>
                                                <p class="card-text">
                                                    <small class="text-muted">Slug: <%= slug %></small><br>
                                                    <small class="text-muted">Criada: <%= empresas[slug].dataCriacao %></small><br>
                                                    <span class="badge bg-primary"><%= (colaboradores[slug] || []).length %> colaboradores</span>
                                                </p>
                                                <div class="d-flex gap-1">
                                                    <a href="/empresa/<%= slug %>" target="_blank" class="btn btn-sm btn-outline-primary">
                                                        <i class="fas fa-external-link-alt"></i>
                                                    </a>
                                                    <a href="/download/<%= slug %>" class="btn btn-sm btn-outline-success">
                                                        <i class="fas fa-download"></i>
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                <% }); %>
                            </div>
                        <% } else { %>
                            <div class="text-center py-5">
                                <i class="fas fa-building fa-3x text-muted mb-3"></i>
                                <h5 class="text-muted">Nenhuma empresa cadastrada</h5>
                                <p class="text-muted">Crie a primeira empresa para começar.</p>
                                <a href="/admin/criar-empresa" class="btn btn-primary">
                                    Criar Primeira Empresa
                                </a>
                            </div>
                        <% } %>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Lista de Colaboradores -->
        <div class="row">
            <div class="col">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Todos os Colaboradores</h5>
                        <small class="text-muted" id="resultadoFiltro">Mostrando todos os cadastros</small>
                    </div>
                    <div class="card-body">
                        <% let temColaboradores = false; %>
                        <% Object.keys(colaboradores).forEach(empresa => { %>
                            <% if ((colaboradores[empresa] || []).length > 0) temColaboradores = true; %>
                        <% }); %>
                        
                        <% if (temColaboradores) { %>
                            <div class="table-responsive">
                                <table class="table table-hover" id="colaboradoresTable">
                                    <thead>
                                        <tr>
                                            <th>Empresa</th>
                                            <th>CPF</th>
                                            <th>Nome</th>
                                            <th>Matrícula</th>
                                            <th>RG</th>
                                            <th>Data Admissão</th>
                                            <th>Tipo Contrato</th>
                                            <th>Data Cadastro</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% Object.keys(colaboradores).forEach(empresaSlug => { %>
                                            <% (colaboradores[empresaSlug] || []).forEach(colaborador => { %>
                                                <tr data-empresa="<%= empresaSlug %>">
                                                    <td>
                                                        <span class="badge bg-primary">
                                                            <%= empresas[empresaSlug].nome %>
                                                        </span>
                                                    </td>
                                                    <td><%= colaborador.cpf %></td>
                                                    <td><%= colaborador.nome %></td>
                                                    <td><%= colaborador.matricula %></td>
                                                    <td><%= colaborador.rg %></td>
                                                    <td><%= colaborador.dataAdmissao %></td>
                                                    <td>
                                                        <span class="badge bg-secondary"><%= colaborador.tipoContrato %></span>
                                                    </td>
                                                    <td><%= colaborador.dataRegistro %></td>
                                                </tr>
                                            <% }); %>
                                        <% }); %>
                                    </tbody>
                                </table>
                            </div>
                        <% } else { %>
                            <div class="text-center py-5">
                                <i class="fas fa-users fa-3x text-muted mb-3"></i>
                                <h5 class="text-muted">Nenhum colaborador cadastrado</h5>
                                <p class="text-muted">Os colaboradores aparecerão aqui quando as empresas começarem a receber cadastros.</p>
                            </div>
                        <% } %>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Função para filtrar por empresa
        function filtrarPorEmpresa() {
            aplicarFiltros();
        }
        
        // Função para aplicar todos os filtros
        function aplicarFiltros() {
            const empresaSelecionada = document.getElementById('filtroEmpresa').value;
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const dataInicio = document.getElementById('dataInicio').value;
            const dataFim = document.getElementById('dataFim').value;
            const table = document.getElementById('colaboradoresTable');
            
            if (!table) return;
            
            const rows = table.getElementsByTagName('tr');
            let visibleCount = 0;
            
            for (let i = 1; i < rows.length; i++) {
                const row = rows[i];
                const cells = row.getElementsByTagName('td');
                const empresaRow = row.getAttribute('data-empresa');
                
                let empresaMatch = !empresaSelecionada || empresaRow === empresaSelecionada;
                let textMatch = false;
                let dateMatch = true;
                
                // Verificar busca por texto
                for (let j = 0; j < cells.length; j++) {
                    if (cells[j].textContent.toLowerCase().includes(searchTerm)) {
                        textMatch = true;
                        break;
                    }
                }
                
                // Se não há termo de busca, considerar como match
                if (!searchTerm) textMatch = true;
                
                // Verificar filtro de data (última coluna = Data Cadastro)
                if (dataInicio || dataFim) {
                    const dataCadastro = cells[cells.length - 1].textContent.trim();
                    const partesData = dataCadastro.split('/');
                    if (partesData.length === 3) {
                        const dataFormatada = `${partesData[2]}-${partesData[1].padStart(2, '0')}-${partesData[0].padStart(2, '0')}`;
                        
                        if (dataInicio && dataFormatada < dataInicio) {
                            dateMatch = false;
                        }
                        if (dataFim && dataFormatada > dataFim) {
                            dateMatch = false;
                        }
                    }
                }
                
                const shouldShow = empresaMatch && textMatch && dateMatch;
                row.style.display = shouldShow ? '' : 'none';
                if (shouldShow) visibleCount++;
            }
            
            // Atualizar contador
            const empresaNome = empresaSelecionada ? 
                document.querySelector(`#filtroEmpresa option[value="${empresaSelecionada}"]`).textContent :
                'todos os cadastros';
            document.getElementById('resultadoFiltro').textContent = 
                `Mostrando ${visibleCount} de ${empresaNome}`;
        }
        
        // Função para limpar filtros
        function limparFiltros() {
            document.getElementById('filtroEmpresa').value = '';
            document.getElementById('searchInput').value = '';
            document.getElementById('dataInicio').value = '';
            document.getElementById('dataFim').value = '';
            aplicarFiltros();
        }
        
        // Busca em tempo real
        document.getElementById('searchInput').addEventListener('keyup', aplicarFiltros);
        
        // Auto-refresh a cada 60 segundos
        setInterval(function() {
            location.reload();
        }, 60000);
    </script>
</body>
</html>